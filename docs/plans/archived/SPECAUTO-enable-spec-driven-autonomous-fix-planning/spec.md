SPECAUTO
Created: 2026-02-10 23:42

# Enable Spec-Driven Autonomous Fix Planning

[AUTOMATION] Add an "Improvement Planner" section to the compiler project's own documentation that instructs the planner to pick random failing specs from ALL rubyspec suites, run them, investigate failures, and generate validated fix plans -- closing the autonomous improvement loop. Add Makefile infrastructure to generate and refresh results across the full rubyspec suite.

## Goal Reference

[COMPLANG](../../goals/COMPLANG-compiler-advancement.md)

## Root Cause

The improvement planner runs inside the compiler's directory and reads CLAUDE.md and README.md automatically (this is standard Claude Code behavior). The Desktop project already exploits this: its README.md contains an "Improvement Planner" section with project-specific guidance ("Do NOT propose", "DO propose", exploration note paths, etc.). The planner follows those instructions because it reads them as part of the project context.

The compiler project has no equivalent section. Its CLAUDE.md covers coding rules (never edit rubyspec, never add operator special cases, etc.) and its README.md covers the project overview. Neither document tells the planner anything about the compiler's rich test infrastructure -- `./run_rubyspec`, the various `docs/rubyspec_*.txt` results files, `make selftest`, `make selftest-c` -- or how to use it when proposing improvements.

Meanwhile, the tracked spec coverage is tiny. Only `docs/rubyspec_language.txt` is referenced anywhere, covering 78 spec files in `rubyspec/language/`. The rubyspec suite contains vastly more: 58 core/ subdirectories (integer, array, hash, string, nil, true, false, symbol, etc.), 59 library/ subdirectories, command_line/ specs, and security/ specs. The runner (`./run_rubyspec`) already supports arbitrary directories -- these suites just aren't being run or tracked.

This is why every compiler fix plan has been rejected:

1. **CASEFIX** was rejected because "run_rubyspec wasn't run" -- the planner proposed a fix without running the spec to verify its diagnosis.
2. **NOPARENS** was rejected as "wrong focus" -- the planner proposed individual fixes instead of improving the automation that generates them.
3. **SPECPICK** was rejected as "aims far too small" -- it only looked at the 78-file language/ suite.

The planner has full tool access and can run any compiler command. It just doesn't know it should. The fix has two parts: (1) generate results for ALL rubyspec suites so the planner has a comprehensive target pool, and (2) add compiler-specific planner guidance to the compiler project's own documentation so the planner knows to pick from those results, run specs live, and ground proposals in actual output.

## Infrastructure Cost

Minimal. This adds:
- An "Improvement Planner" section to the compiler's README.md (the same mechanism Desktop already uses)
- Makefile targets for each rubyspec suite area and a combined `rubyspec-all` target
- Initial results files generated by running those targets

No changes to `bin/improve` or any shared tooling. No new scripts beyond Makefile targets. No new cron entries, no permission changes.

## Prior Plans

- [SPECPICK](../archived/SPECPICK-rubyspec-target-picker/spec.md) -- REJECTED: "aims far too small" and "just focus on rubyspec_language.txt." SPECPICK proposed a ranking script for only the 78-file language suite. SPECAUTO covers all suites and avoids new tooling.

- [SPECWIDE](../archived/SPECWIDE-broad-rubyspec-baseline/spec.md) -- REJECTED: "ignored the feedback to reuse the improvement planner and instead suggested building a separate infrastructure." SPECWIDE proposed a new `/fixspec` command. SPECAUTO works entirely through the existing planner by adding project-local documentation and Makefile targets.

- [CASEFIX](../archived/CASEFIX-fix-case-spec-crash/spec.md) -- REJECTED: "hasn't been validated. run_rubyspec wasn't run. Wrong focus to create individual plans for unvalidated problems instead of addressing automation." SPECAUTO ensures the planner always runs specs before proposing, preventing future unvalidated proposals.

- [NOPARENS](../archived/NOPARENS-fix-noparens-default-block-segfault/spec.md) -- REJECTED: "Wrong focus to do this rather than improve automation of fixes." SPECAUTO IS the automation improvement that enables validated fix plans to be generated automatically.

## Scope

**In scope:**
- Add Makefile targets that run `./run_rubyspec` against every rubyspec suite area, capturing results to `docs/rubyspec_*.txt` files:
  - `make rubyspec-language` (already exists, runs `rubyspec/language/`)
  - `make rubyspec-core` (new: runs all of `rubyspec/core/`, captures to `docs/rubyspec_core.txt`)
  - `make rubyspec-library` (new: runs `rubyspec/library/`, captures to `docs/rubyspec_library.txt`)
  - `make rubyspec-command-line` (new: runs `rubyspec/command_line/`, captures to `docs/rubyspec_command_line.txt`)
  - `make rubyspec-security` (new: runs `rubyspec/security/`, captures to `docs/rubyspec_security.txt`)
  - `make rubyspec-all` (new: runs all of the above sequentially, captures combined summary)
- A `make rubyspec-refresh` target that re-runs `make rubyspec-all` only if results are older than 24 hours
- Run `make rubyspec-all` once to establish baseline results for all suites
- Add an "Improvement Planner" section to the compiler's [README.md](../../../README.md) that instructs the planner to: read from ALL results files (`docs/rubyspec_*.txt`), pick a random non-passing spec from any suite, run it with `./run_rubyspec`, analyze the output, and propose a fix plan grounded in that live output
- Include guidance for the explore agent in the same section so that compiler explorations include spec execution, not just file reading
- Update the COMPLANG goal to reflect the broadened coverage

**Out of scope:**
- Editing `bin/improve` or any shared tooling (project-specific instructions belong in the project's own documentation)
- Building new scripts or commands beyond Makefile targets (no `/fixspec`, no `pick_rubyspec_target.rb`)
- Changing tool permissions (the planner already has full tool access)
- Changing the planner's core architecture or adding new agent modes
- Actually fixing any specs (that will be done by future plans that THIS enables)
- Modifying `run_rubyspec` itself (it already handles arbitrary directories)

## Expected Payoff

- The compiler's tracked spec coverage expands from 78 files (language/ only) to the entire rubyspec suite (thousands of spec files across language/, core/, library/, command_line/, and security/)
- Every future compiler improvement plan will be validated against live spec output before being proposed -- eliminating the "unvalidated" rejection pattern
- The planner becomes the autonomous fix cycle: each daily invocation picks a random failing spec from any suite, investigates it, and produces a ready-to-execute fix plan
- No new infrastructure to maintain -- reuses existing planner, existing `run_rubyspec`, and the same documentation-driven mechanism Desktop already uses
- The broadened baseline reveals the compiler's actual compliance posture across all of Ruby, not just the language/ subset

## Proposed Approach

### Phase 1: Makefile targets and baseline results

1. Add `make rubyspec-core` target to the [Makefile](../../../Makefile):
   ```makefile
   .PHONY: rubyspec-core
   rubyspec-core:
   	./run_rubyspec rubyspec/core/ 2>&1 | tee docs/rubyspec_core.txt
   ```

2. Add equivalent targets for `rubyspec-library`, `rubyspec-command-line`, `rubyspec-security`.

3. Add `make rubyspec-all` that runs all suite targets sequentially:
   ```makefile
   .PHONY: rubyspec-all
   rubyspec-all: rubyspec-language rubyspec-core rubyspec-library rubyspec-command-line rubyspec-security
   ```

4. Add `make rubyspec-refresh` that conditionally re-runs if results are stale (older than 24 hours).

5. Run `make rubyspec-all` to generate baseline results. Note: the core/ and library/ runs will be slow (potentially hours for the full suite). This is acceptable as a one-time baseline generation.

### Phase 2: README.md planner guidance

6. Add an "Improvement Planner" section to [README.md](../../../README.md) containing:
   a. Instructions to read ALL `docs/rubyspec_*.txt` files to find non-passing spec files across every suite
   b. Instructions to pick one at random (not rank -- SPECPICK was rejected for ranking)
   c. Instructions to run it: `./run_rubyspec rubyspec/SUITE/SPECFILE.rb`
   d. Instructions to analyze the output to identify the root cause (crash, missing method, wrong result, etc.)
   e. Instructions to propose a fix plan grounded in that specific live output, including actual error messages
   f. A requirement that proposed plans' acceptance criteria include running the spec to verify the fix AND running `make selftest` and `make selftest-c` to prevent regressions
   g. Guidance for exploration runs to include live spec execution, not just static file reading
   h. "Do NOT propose" and "DO propose" lists tailored to compiler improvement patterns (e.g., do not propose unvalidated fixes; do propose fixes backed by live spec output)

### Phase 3: Update COMPLANG goal

7. Update [COMPLANG](../../goals/COMPLANG-compiler-advancement.md) to reference the broadened suite coverage and new Makefile targets, replacing references to the 78-file language/ subset.

## Acceptance Criteria

- [ ] The Makefile contains targets for `rubyspec-core`, `rubyspec-library`, `rubyspec-command-line`, `rubyspec-security`, `rubyspec-all`, and `rubyspec-refresh`
- [ ] Each new target runs `./run_rubyspec` against the corresponding rubyspec directory and captures output to `docs/rubyspec_*.txt`
- [ ] `make rubyspec-refresh` only re-runs if results are older than 24 hours
- [ ] Baseline results files exist for all suites (`docs/rubyspec_core.txt`, `docs/rubyspec_library.txt`, `docs/rubyspec_command_line.txt`, `docs/rubyspec_security.txt`, plus the existing `docs/rubyspec_language.txt`)
- [ ] The compiler's README.md contains an "Improvement Planner" section that instructs the planner to read from ALL `docs/rubyspec_*.txt` results files, pick a random non-passing spec from any suite, run it with `./run_rubyspec`, and base proposals on the live output
- [ ] The section includes guidance for exploration runs to execute specs rather than only reading static files
- [ ] The section includes "Do NOT propose" guidance that excludes unvalidated fix proposals and individual spec fixes without prior live investigation
- [ ] The section includes "DO propose" guidance that favors fixes backed by live spec output and automation improvements
- [ ] `bin/improve` is NOT modified (all instructions come from compiler project documentation)
- [ ] `make selftest` and `make selftest-c` still pass (no compiler code changes in this plan)
- [ ] The existing `make rubyspec-language`, `make rubyspec-integer`, and `make rubyspec-regexp` targets are preserved and still work
- [ ] A test invocation of the planner against the compiler, after the README.md changes, produces a plan that references specific spec output from an actual run -- verified by checking the plan's Root Cause section cites actual error output

---
*Status: REJECTED â€” The plan iterations keeps coming up with confused solutions that are pointlessly complicated and/or not generic enough.*